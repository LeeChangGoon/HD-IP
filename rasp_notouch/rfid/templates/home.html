<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>RFID 웹 애플리케이션</title>
  <style>
    :root{
      --brand:#006f3c;
      --brand-dark:#004f2d;
      --fg:#1d1d1f;
      --bg:#f9f9f9;
      --card:#fff;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
      -webkit-font-smoothing:antialiased;
      text-align:center;
    }

    /* 상단 고정 헤더 */
    .header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:flex-end;
      padding:0 10px; pointer-events:none;
    }
    .add-user-btn{
      pointer-events:auto;
      background:var(--brand); color:#fff; border:0; cursor:pointer;
      font-size:clamp(14px, 1.6vw, 18px);
      padding:.75em 1.1em; border-radius:10px;
      box-shadow:0 4px 14px rgba(0,0,0,.12);
      touch-action:manipulation;
    }
    .add-user-btn:hover{ background:var(--brand-dark) }
    .add-user-btn:focus{ outline:3px solid #9bd3b3; outline-offset:2px }

    /* 콘텐츠 중앙 정렬 */
    .wrap{
      min-height:100%;
      display:flex; align-items:center; justify-content:center;
      padding:72px 16px 24px; /* 헤더 여유 */
    }
    .container{
      width:min(92vw, 720px);
      background:var(--card);
      border:2px solid var(--brand);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding: clamp(18px, 3.5vw, 32px);
    }

    h1{
      color:var(--brand);
      font-weight:700;
      font-size: clamp(36px, 8vw, 72px);
      line-height:1.1;
      margin: clamp(12px, 3vw, 20px) 0;
    }
    h2{
      color:var(--brand);
      font-weight:600;
      font-size: clamp(28px, 6vw, 48px);
      line-height:1.2;
      margin: clamp(10px, 2.5vw, 18px) 0;
    }

    .hint{
      font-size: clamp(16px, 2.8vw, 20px);
      color:#3d8e60;
      margin-top: clamp(6px, 2vw, 12px);
    }

    .spinner{
      width: clamp(40px, 8vw, 64px);
      height: clamp(40px, 8vw, 64px);
      margin: clamp(16px, 3vw, 24px) auto;
      border-radius:50%;
      border:6px solid #e7efe9;
      border-top:6px solid var(--brand);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* 모션 최소화 환경 */
    @media (prefers-reduced-motion:reduce){
      .spinner{ animation:none }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="add-user-btn" type="button" onclick="location.href='/'">관리 페이지</button>
  </div>

  <div class="wrap">
    <main class="container" role="main">
      <h1>폐페인트 수거장치</h1>
      <h2>카드를 태깅해주세요.</h2>

      <div class="spinner" aria-hidden="true"></div>
      <div id="hint" class="hint" aria-live="polite">RFID 확인 중…</div>

      <!-- 필요 시 수동 새로고침 버튼 (주석 해제해서 사용)
      <button class="btn" type="button" onclick="location.reload()">새로고침</button>
      -->
    </main>
  </div>

  <script>
    // === LAN 전용: 온라인/오프라인 배지/감지 제거 ===
    (function () {
      const ENDPOINT = "{% url 'check_rfid' %}";
      const hintEl = document.getElementById('hint');

      const BASE_DELAY = 1000;   // 정상 주기 1s
      const MAX_DELAY  = 5000;   // 오류 시 최대 5s (백오프는 유지)
      let delay = BASE_DELAY;
      let stopped = false;
      let controller = null;

      // 페이지가 숨겨지면 폴링 일시정지 (리소스 절약)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && controller) controller.abort();
      });

      async function checkRFID() {
        if (document.hidden) return;
        hintEl.textContent = 'RFID 확인 중…';

        if (controller) controller.abort();
        controller = new AbortController();

        try {
          const resp = await fetch(ENDPOINT, {
            method: 'GET',
            cache: 'no-store',
            signal: controller.signal,
            headers: {'Accept':'application/json'}
          });

          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json().catch(()=> ({}));

          if (data && data.uid) {
            stopped = true;
            hintEl.textContent = '인식됨: 이동 중…';
            window.location.replace(`/disposal/${encodeURIComponent(data.uid)}/`);
            return;
          }

          // UID 없음: 정상 루프
          delay = BASE_DELAY;
        } catch (err) {
          // 오류 시 조용히 백오프만 적용 (배지/메시지 없음)
          delay = Math.min(MAX_DELAY, Math.round(delay * 1.6));
          // 참고: 필요하면 콘솔 로깅만 유지
          // console.warn('[RFID poll retry]', err);
        }
      }

      (function loop(){
        if (stopped) return;
        checkRFID().finally(() => {
          if (!stopped) setTimeout(loop, delay);
        });
      })();
    })();
  </script>
</body>
</html>
